# 数据库存储管理

## 概述

系统现在支持自动数据清理和存储上限管理，确保数据库不会无限增长，同时保持系统性能。

## 核心功能

### 1. 数据时效管理
- **默认保留时间**: 24小时
- **自动清理**: 每小时检查一次
- **清理内容**: 超过时效的K线数据、异动记录、AI选币记录、持仓量排行

### 2. 存储上限控制
- **文件大小限制**: 默认100MB
- **记录数限制**: 每个合约最多10000条K线
- **触发机制**: 超限时自动清理最旧数据

### 3. 智能清理策略
- **时间优先**: 优先删除超过时效的数据
- **容量管理**: 超过大小限制时清理最旧数据
- **性能优化**: 删除大量数据后自动执行VACUUM

## 配置说明

### config.py 配置文件

```python
DATABASE_CONFIG = {
    # 数据库文件路径
    "db_path": "data.db",
    
    # 数据保留时间（小时）
    "max_age_hours": 24,
    
    # 清理检查间隔（秒）
    "cleanup_interval": 3600,  # 1小时
    
    # 自动清理开关
    "auto_cleanup": True,
    
    # 数据库大小限制（MB，0表示无限制）
    "max_db_size_mb": 100,
    
    # 记录数限制（0表示无限制）
    "max_klines_per_symbol": 10000,
}
```

### 参数说明

- **max_age_hours**: 数据保留时间，超过此时间的数据将被删除
- **cleanup_interval**: 自动清理检查间隔，建议1-4小时
- **auto_cleanup**: 是否启用自动清理，生产环境建议开启
- **max_db_size_mb**: 数据库文件大小上限，0表示无限制
- **max_klines_per_symbol**: 每个合约保留的最大K线数量

## 管理工具

### 1. 信息查看

```bash
# 查看数据库当前状态
python cleanup.py --info
```

输出示例：
```
=== 数据库信息 ===
文件大小: 15.2 MB
数据保留时间: 24 小时
监控合约数量: 151
K线数据条数: 12450
24小时异动数: 25

=== 各表记录数 ===
K线数据: 12450
异动数据: 156
AI选币: 20
持仓量排行: 20

=== 最旧数据时间 ===
K线数据: 2025-11-06 15:30:00
异动数据: 2025-11-06 16:45:00
```

### 2. 手动清理

```bash
# 清理超过24小时的数据（默认）
python cleanup.py

# 清理超过12小时的数据
python cleanup.py --hours 12

# 强制清理，不询问确认
python cleanup.py --hours 6 --force
```

### 3. 测试清理功能

```bash
# 测试清理功能（使用临时数据库）
python test_cleanup.py

# 测试生产数据库清理
python test_cleanup.py production
```

## 系统监控

### 启动时显示
系统启动时会显示数据库配置信息：

```
📊 数据库配置:
- 数据保留时间: 24 小时
- 清理检查间隔: 60 分钟
- 当前数据库大小: 15.2 MB
- 监控合约数量: 151
- K线数据条数: 12450
```

### 运行时监控
系统运行时每30秒显示一次状态：

```
[18:30:15] 监控合约: 151, K线数据: 12450, 24h异动: 25
```

### 清理日志
清理操作会记录详细日志：

```
2025-11-07 18:30:00 - INFO - 数据清理完成: K线=1250, 异动=45, AI选币=0, 持仓量排行=0
2025-11-07 18:30:01 - INFO - 执行VACUUM优化数据库
```

## 最佳实践

### 1. 生产环境配置
- 数据保留时间：24-48小时
- 清理间隔：1-2小时
- 文件大小限制：50-200MB
- 启用自动清理

### 2. 测试环境配置
- 数据保留时间：1-6小时
- 清理间隔：30分钟
- 文件大小限制：10-50MB
- 启用自动清理

### 3. 开发环境配置
- 数据保留时间：1-2小时
- 清理间隔：15-30分钟
- 文件大小限制：5-20MB
- 可关闭自动清理进行调试

## 故障排除

### 1. 数据库增长过快
- 检查清理配置是否正确
- 降低数据保留时间
- 减小记录数限制
- 增加清理频率

### 2. 性能问题
- 启用定期VACUUM
- 检查索引是否正常
- 考虑调整批量插入大小
- 监控磁盘I/O性能

### 3. 数据丢失
- 检查清理时间配置
- 确认清理策略是否合适
- 备份重要数据
- 调整保留时间

## API接口

系统状态可通过API接口查询：

```bash
# 健康检查（包含数据库信息）
curl http://localhost:5000/api/health

# 响应示例
{
    "status": "healthy",
    "database": {
        "file_size_mb": 15.2,
        "max_age_hours": 24,
        "symbol_count": 151,
        "kline_count": 12450,
        "anomaly_count_24h": 25
    },
    "timestamp": "2025-11-07T18:30:00Z"
}
```